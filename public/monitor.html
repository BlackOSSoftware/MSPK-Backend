<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSPK System Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f1115; color: #e1e1e1; margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .card { background: #1a1d23; padding: 20px; border-radius: 8px; border: 1px solid #333; }
        .card h3 { margin-top: 0; color: #888; font-size: 0.9em; text-transform: uppercase; }
        .value { font-size: 2.5em; font-weight: bold; }
        .unit { font-size: 0.4em; color: #666; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-green { background: #00c853; box-shadow: 0 0 10px #00c853; }
        .status-yellow { background: #ffd600; box-shadow: 0 0 10px #ffd600; }
        .status-red { background: #d50000; box-shadow: 0 0 10px #d50000; }
        .chart-container { height: 200px; margin-top: 20px; }
        #alerts { background: #261a1a; border-left: 4px solid #d50000; padding: 10px; margin-bottom: 20px; display: none; }
    </style>
</head>
<body>
    <h1 style="margin-bottom: 20px;">
        <span id="statusIndicator" class="status-dot status-green"></span>
        System Monitor
        <span style="font-size: 0.4em; color: #555; vertical-align: middle; margin-left: 10px;">v1.0</span>
    </h1>

    <div id="alerts"></div>

    <div class="grid">
        <!-- API -->
        <div class="card">
            <h3>API Load</h3>
            <div class="value" id="apiReq">0 <span class="unit">req/min</span></div>
            <div style="color: #666; margin-top: 5px;">Latency: <span id="apiLat">0</span>ms</div>
            <canvas id="chartApi" class="chart-container"></canvas>
        </div>

        <!-- Cache -->
        <div class="card">
            <h3>Cache Performance</h3>
            <div class="value" id="cacheHit">0% <span class="unit">hit rate</span></div>
            <div style="color: #666; margin-top: 5px;">H: <span id="hits">0</span> / M: <span id="misses">0</span></div>
            <canvas id="chartCache" class="chart-container"></canvas>
        </div>

        <!-- WebSocket -->
        <div class="card">
            <h3>WebSocket</h3>
            <div class="value" id="wsConn">0 <span class="unit">conn</span></div>
            <div style="color: #666; margin-top: 5px;">Queue: <span id="wsQueue">0</span> | Msg/s: <span id="wsMsg">0</span></div>
            <canvas id="chartWs" class="chart-container"></canvas>
        </div>

        <!-- Issues -->
        <div class="card">
            <h3>Critical Events</h3>
            <div class="value" id="err429" style="color: #ff5252">0 <span class="unit">429s</span></div>
            <div style="color: #666; margin-top: 5px;">Memory: <span id="memUsage">0</span> MB</div>
        </div>
    </div>

    <script>
        const ctxApi = document.getElementById('chartApi').getContext('2d');
        const ctxCache = document.getElementById('chartCache').getContext('2d');
        const ctxWs = document.getElementById('chartWs').getContext('2d');

        const chartConfig = (color) => ({
            type: 'line',
            data: { labels: Array(30).fill(''), datasets: [{ data: Array(30).fill(0), borderColor: color, tension: 0.4, borderWidth: 2, pointRadius: 0 }] },
            options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, maintainAspectRatio: false }
        });

        const chart1 = new Chart(ctxApi, chartConfig('#29b6f6'));
        const chart2 = new Chart(ctxCache, chartConfig('#66bb6a'));
        const chart3 = new Chart(ctxWs, chartConfig('#ffa726'));

        function updateChart(chart, val) {
            chart.data.datasets[0].data.push(val);
            chart.data.datasets[0].data.shift();
            chart.update();
        }

        async function fetchMetrics() {
            try {
                const res = await fetch('/v1/metrics');
                const data = await res.json();
                
                // Update DOM
                document.getElementById('apiReq').innerText = data.api.requests_per_minute;
                document.getElementById('apiLat').innerText = data.derived.avg_api_latency;
                document.getElementById('cacheHit').innerText = data.derived.cache_hit_rate + '%';
                document.getElementById('hits').innerText = data.cache.hits;
                document.getElementById('misses').innerText = data.cache.misses;
                document.getElementById('wsConn').innerText = data.websocket.connections;
                document.getElementById('wsQueue').innerText = data.websocket.queue_length;
                document.getElementById('wsMsg').innerText = data.websocket.messages_sent_sec;
                document.getElementById('err429').innerText = data.api.errors_429;
                document.getElementById('memUsage').innerText = data.system.memory_usage_mb;

                // Charts
                updateChart(chart1, data.api.requests_per_minute);
                updateChart(chart2, data.derived.cache_hit_rate);
                updateChart(chart3, data.websocket.messages_sent_sec);

                // Status Logic
                const dot = document.getElementById('statusIndicator');
                if (data.api.errors_429 > 0) dot.className = 'status-dot status-red';
                else if (data.derived.cache_hit_rate < 50 && data.api.requests_per_minute > 5) dot.className = 'status-dot status-yellow';
                else dot.className = 'status-dot status-green';

            } catch (e) {
                console.error(e);
            }
        }

        setInterval(fetchMetrics, 2000);
        fetchMetrics();
    </script>
</body>
</html>
